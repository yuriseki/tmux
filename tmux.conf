# More inspiration for configuration
# https://github.com/rothgar/awesome-tmux

################################################################################
# Main configuration.
################################################################################
source-file ~/.config/tmux/tmux.reset.conf

# Configure colors
set-option -g default-terminal "tmux-256color"
set-option -g terminal-overrides ',xterm-256color:RGB'

# Server options
set-option -s focus-events on
set-option -s extended-keys on
set-option -s escape-time 0

# Prevent conflicts when inside Neovim
setw -g aggressive-resize on

################################################################################
# Key bindings.
################################################################################
# Update the leader key.
set -g prefix C-\\ 
bind C-\\ send-prefix
set -g mouse on
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "xclip -selection clipboard -i"

# Reload configuration.
unbind r
bind-key r source-file ~/.config/tmux/tmux.conf

# Panes navigation.
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R
bind-key Left select-pane -L
bind-key Down select-pane -D
bind-key Up select-pane -U
bind-key Right select-pane -R

set-option -g base-index 1
set-option -g pane-base-index 1
set -g renumber-windows on # Keeps widows numbers sequential.
set-option -g history-limit 30000


bind-key c new-window -c "#{pane_current_path}"
bind-key '"' split-window -h -c "#{pane_current_path}"
bind-key '%' split-window -v -c "#{pane_current_path}"
bind-key C-x kill-pane

# --- SPLITS ---------------------------------------------------------------
bind | split-window -h
bind - split-window -v
unbind '"'
unbind %


################################################################################
# Popup windows
################################################################################
bind-key C-i display-popup -E -w 90% -h 90% "mkdir ~/scratches -p && cd ~/scratches/ && touch scratch.md && nvim scratch.md"
# Open a new pop session matching the main session.
bind-key C-p run-shell '
  CURRENT_SESSION=$(tmux display-message -p "#{session_name}")
  CURRENT_WINDOW=$(tmux display-message -p "#{window_index}")
  CURRENT_PATH=$(tmux display-message -p "#{pane_current_path}")

  # Create the scratchpad session if needed
  if ! tmux has-session -t "${CURRENT_SESSION}-popup" 2>/dev/null; then
    tmux new-session -d -s "${CURRENT_SESSION}-popup" -n 0 -c "$CURRENT_PATH"
  fi

  # Create matching window if needed
  if ! tmux has-session -t "${CURRENT_SESSION}-popup":$CURRENT_WINDOW 2>/dev/null; then
    tmux new-window -d -t "${CURRENT_SESSION}-popup":$CURRENT_WINDOW -c "$CURRENT_PATH"
  fi

  # IMPORTANT: fix quoting so no script leaks into popup
  tmux display-popup -E "tmux attach-session -t ${CURRENT_SESSION}-popup:${CURRENT_WINDOW}"
'

# Alt + s → fuzzy switch session
bind -n M-s display-popup -E '
  session=$(tmux list-sessions -F "#{session_name}" \
  | sort \
  | fzf --reverse --prompt="Switch session > "); \
  [ -n "$session" ] && tmux switch-client -t "$session"
'

# Leader + D: delete session permanently
# bind-key M-D display-popup -E "nvim"#"~/.tmux/delete_session.sh"
bind-key M-d display-popup -E "~/.config/tmux/delete_session.sh" 

################################################################################
# Styling
# Bluloco color scheme.  
################################################################################
CURSOR_LINE="#384151"
BG="#282C34"
BGFLOAT="#21242D"
FG="#ABB2BF"
CURSOR="#FFCC00"
KEYWORD="#10B1FE"
COMMENT="#636D83"
PUNCTUATION="#7A82DA"
METHOD="#3FC56B"
TYPE="#FF6480"
STRING="#F9C859"
NUMBER="#FF78F8"
CONSTANT="#9F7EFE"
TAG="#3691FF"
ATTRIBUTE="#FF936A"
PROPERTY="#CE9887"
PARAMETER="#8bcdef"
LABEL="#50acae"
MODULE="#FF839B"
RIGHT_END=""
RIGHT_START=""
LEFT_END=""
LEFT_START=""

################################################################################
# Status-bar configuration.
################################################################################
set-option -g set-titles-string "#{pane_title}" # Set the terminal application title
set-option -g status-position top
set-option -g status-style bg=${BGFLOAT},fg=${FG}


# Left content: Session name, Tmux key indicator
set -g status-left-length 150
set-option -g status-left "\
#[bg=${BGFLOAT},fg=${KEYWORD}]#[reverse] #S \
#{?client_prefix, #[bg=${TYPE}]#[noreverse]#[fg=${BGFLOAT}]  #[fg=${BGFLOAT}] , #[bg=${BGFLOAT}]#[fg=${COMMENT}]#[noreverse]    }"


# Show the window list centered between the left and the right section
set-option -g status-justify centre

# Style and set content for the active windows
set-option -g window-status-current-format "\
#[fg=${CURSOR_LINE},bg=${BGFLOAT} ]\
#[fg=${FG},bg=#{CURSOR_LINE}]#I\
#[fg=${TYPE},bold]:\
#[fg=${FG},bg=#{CURSOR_LINE},none]#{b:pane_current_path}\
#[fg=${CURSOR_LINE},bg=${BGFLOAT}]\
"

# Style and set content for the inactive windows
set-option -g window-status-format "\
 \
#I\
#[fg=${KEYWORD}]:\
#[fg=${FG}]#{b:pane_current_path}\
 \
"

# Right content: Applivation name, Hostname
set-option -g status-right "\
#[bg=${BGFLOAT},fg=${STRING}]#[reverse] #W #[noreverse]\
#[bg=${STRING},fg=${KEYWORD}]#[reverse] #[bg=${BGFLOAT},fg=${KEYWORD}]#h "


################################################################################
# Plugins configuration.
################################################################################
set -g @continuum-restore 'on'
set -g @continuum-save-interval '5' # Save every 5 minutes

################################################################################
# List of plugins
################################################################################
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible' # Better overal configuration
set -g @plugin 'tmux-plugins/tmux-resurrect' # Save and restore sessions
set -g @plugin 'tmux-plugins/tmux-continuum' # Auto restore session
set -g @plugin 'tmux-plugins/tmux-yank'

run '~/.config/tmux/plugins/tpm/tpm'

################################################################################
# Main configuration.
################################################################################
# Configure colors
set-option -g default-terminal "tmux-256color"
set-option -g terminal-overrides ',xterm-256color:RGB'

# Server options
set-option -s focus-events on
set-option -s extended-keys on
set-option -s escape-time 0

# Prevent conflicts when inside Neovim
setw -g aggressive-resize on

################################################################################
# Key bindings.
################################################################################
# Update the leader key.
set -g prefix C-\\ 
bind C-\\ send-prefix
set -g mouse on
# bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "xclip -selection clipboard -i"

# Enter copy mode with mouse drag and copy to system clipboard
# set -g mode-keys vi
#
# # Use the CLIPBOARD target, not PRIMARY
# bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "xclip -selection clipboard -i"
# bind -T copy-mode MouseDragEnd1Pane send -X copy-pipe-and-cancel "xclip -selection clipboard -i"

# allow native selection
unbind -T copy-mode-vi MouseDrag1Pane
unbind -T copy-mode MouseDrag1Pane
unbind -T copy-mode-vi MouseDragEnd1Pane
unbind -T copy-mode MouseDragEnd1Pane

# Reload configuration.
unbind r
bind-key r source-file ~/.config/tmux/tmux.conf

# Panes navigation.
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R
bind-key Left select-pane -L
bind-key Down select-pane -D
bind-key Up select-pane -U
bind-key Right select-pane -R

set-option -g base-index 1
set-option -g pane-base-index 1
set -g renumber-windows on # Keeps widows numbers sequential.
set-option -g history-limit 30000


bind-key c new-window -c "#{pane_current_path}"
bind-key '"' split-window -h -c "#{pane_current_path}"
bind-key '%' split-window -v -c "#{pane_current_path}"

# --- SPLITS ---------------------------------------------------------------
bind | split-window -h
bind - split-window -v
unbind '"'
unbind %

# Alt + s → fuzzy switch session
bind -n M-s display-popup -E '
  session=$(tmux list-sessions -F "#{session_name}" \
  | grep -v -- "-popup$" \
  | sort \
  | fzf --reverse --prompt="Switch session > "); \
  [ -n "$session" ] && tmux switch-client -t "$session"
'

################################################################################
# Popup windows
################################################################################
bind-key C-i display-popup -E -w 90% -h 90% "mkdir ~/scratches -p && cd ~/scratches/ && touch scratch.md && nvim scratch.md"
# Open a new pop session matching the main session.
bind-key C-p run-shell '
  CURRENT_SESSION=$(tmux display-message -p "#{session_name}")
  CURRENT_WINDOW=$(tmux display-message -p "#{window_index}")
  CURRENT_PATH=$(tmux display-message -p "#{pane_current_path}")

  # --- CASE 1: If we are already inside a popup session ---
  case "$CURRENT_SESSION" in
    *-popup)
      # Instead of opening nested popups → detach
      tmux detach-client
      exit 0
      ;;
  esac

  # --- CASE 2: Normal session → open popup ---
  # Create popup session if missing
  if ! tmux has-session -t "${CURRENT_SESSION}-popup" 2>/dev/null; then
    tmux new-session -d -s "${CURRENT_SESSION}-popup" -n 0 -c "$CURRENT_PATH"
  fi

  # Create matching window if missing
  if ! tmux has-session -t "${CURRENT_SESSION}-popup":$CURRENT_WINDOW 2>/dev/null; then
    tmux new-window -d -t "${CURRENT_SESSION}-popup":$CURRENT_WINDOW -c "$CURRENT_PATH"
  fi

  # Open popup attached to that window
  tmux display-popup -E -w 80% -h 50% "tmux attach-session -t ${CURRENT_SESSION}-popup:${CURRENT_WINDOW}"
'



################################################################################
# Styling
# Bluloco color scheme.  
################################################################################
CURSOR_LINE="#384151"
BG="#282C34"
BGFLOAT="#21242D"
FG="#ABB2BF"
CURSOR="#FFCC00"
KEYWORD="#10B1FE"
COMMENT="#636D83"
PUNCTUATION="#7A82DA"
METHOD="#3FC56B"
TYPE="#FF6480"
STRING="#F9C859"
NUMBER="#FF78F8"
CONSTANT="#9F7EFE"
TAG="#3691FF"
ATTRIBUTE="#FF936A"
PROPERTY="#CE9887"
PARAMETER="#8bcdef"
LABEL="#50acae"
MODULE="#FF839B"
RIGHT_END=""
RIGHT_START=""
LEFT_END=""
LEFT_START=""

################################################################################
# Status-bar configuration.
################################################################################
set-option -g set-titles-string "#{pane_title}" # Set the terminal application title
set-option -g status-position top
set-option -g status-style bg=${BGFLOAT},fg=${FG}


# Left content: Session name, Tmux key indicator
set -g status-left-length 150
set-option -g status-left "\
#[bg=${BGFLOAT},fg=${KEYWORD}]#[reverse] #S \
#{?client_prefix, #[bg=${TYPE}]#[noreverse]#[fg=${BGFLOAT}]  #[fg=${BGFLOAT}] , #[bg=${BGFLOAT}]#[fg=${COMMENT}]#[noreverse]    }"


# Show the window list centered between the left and the right section
set-option -g status-justify centre

# Style and set content for the active windows
set-option -g window-status-current-format "\
#[fg=${CURSOR_LINE},bg=${BGFLOAT} ]\
#[fg=${FG},bg=#{CURSOR_LINE}]#I\
#[fg=${TYPE},bold]:\
#[fg=${FG},bg=#{CURSOR_LINE},none]#W\
#[fg=${CURSOR_LINE},bg=${BGFLOAT}]\
"

# Style and set content for the inactive windows
set-option -g window-status-format "\
 \
#I\
#[fg=${KEYWORD}]:\
#[fg=${FG}]#W\
 \
"

# Right content: Applivation name, Hostname
set-option -g status-right "\
#[bg=${BGFLOAT},fg=${STRING}]#[reverse] #{b:pane_current_path} #[noreverse]\
#[bg=${STRING},fg=${KEYWORD}]#[reverse] #[bg=${BGFLOAT},fg=${KEYWORD}]#h "


################################################################################
# Plugins configuration.
################################################################################
set -g @continuum-restore 'on'
set -g @continuum-save-interval '5' # Save every 5 minutes
set -g @resurrect-dir '~/.config/tmux/resurrect'


################################################################################
# List of plugins
################################################################################
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible' # Better overal configuration
set -g @plugin 'tmux-plugins/tmux-resurrect' # Save and restore sessions
set -g @plugin 'tmux-plugins/tmux-continuum' # Auto restore session
set -g @plugin 'tmux-plugins/tmux-yank'

run '~/.config/tmux/plugins/tpm/tpm'
